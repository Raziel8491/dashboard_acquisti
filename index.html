<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Dashboard Acquisti">
    <title>Dashboard Acquisti</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --bg-primary: #1a1f2e;
            --bg-secondary: #232940;
            --bg-tertiary: #2a2f45;
            --accent: #5b8def;
            --text-primary: #ffffff;
            --text-secondary: #8b92a8;
            --success: #4caf50;
            --danger: #d32f2f;
            --border: #2e3548;
            --card-dark: #262d40;
            --card-red: #c62828;
            --card-green: #2e7d32;
            --card-blue: #0277bd;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 393px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        h2 {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 4px;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:active {
            transform: scale(0.96);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-small {
            padding: 10px 20px;
            font-size: 14px;
        }

        /* Stats Grid - Home Page */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .stat-card:active {
            transform: scale(0.98);
        }

        .stat-card.dark {
            background: var(--card-dark);
        }

        .stat-card.red {
            background: var(--card-red);
        }

        .stat-card.green {
            background: var(--card-green);
        }

        .stat-card.blue {
            background: var(--card-blue);
        }

        .stat-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 22px;
            font-weight: 700;
            color: white;
            word-break: break-word;
            line-height: 1.2;
        }

        .stat-subtitle {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 4px;
        }

        /* Summary Card - Dettaglio Lotto */
        .summary-card {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 30px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 16px;
        }

        .summary-item {
            text-align: center;
        }

        .summary-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .summary-value {
            font-size: 18px;
            font-weight: 700;
            line-height: 1.2;
        }

        /* Lotto Cards */
        .lotto-card {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            animation: fadeInUp 0.4s ease forwards;
            opacity: 0;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .lotto-card:nth-child(1) { animation-delay: 0.1s; }
        .lotto-card:nth-child(2) { animation-delay: 0.2s; }
        .lotto-card:nth-child(3) { animation-delay: 0.3s; }
        .lotto-card:nth-child(4) { animation-delay: 0.4s; }
        .lotto-card:nth-child(5) { animation-delay: 0.5s; }

        .lotto-card:active {
            transform: scale(0.98);
        }

        .lotto-header {
            margin-bottom: 16px;
        }

        .lotto-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .lotto-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            font-size: 13px;
        }

        .lotto-stat-item {
            text-align: center;
        }

        .lotto-stat-label {
            color: var(--text-secondary);
            margin-bottom: 4px;
            font-size: 11px;
        }

        .lotto-stat-value {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 13px;
        }

        /* Record Items */
        .record-item {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .record-text {
            font-weight: 500;
            flex: 1;
            color: var(--text-primary);
        }

        .record-actions {
            display: flex;
            gap: 8px;
        }

        .record-values {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            font-size: 13px;
        }

        .record-value-item {
            text-align: center;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .record-value-label {
            color: var(--text-secondary);
            font-size: 11px;
            margin-bottom: 4px;
        }

        .delete-record-btn, .edit-record-btn {
            border: none;
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            font-weight: 600;
        }

        .delete-record-btn {
            background: var(--danger);
            color: white;
        }

        .edit-record-btn {
            background: var(--accent);
            color: white;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            backdrop-filter: blur(12px);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 24px;
            padding: 32px;
            width: 90%;
            max-width: 400px;
            border: 1px solid var(--border);
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 22px;
            font-weight: 700;
        }

        .close-btn {
            font-size: 28px;
            color: var(--text-secondary);
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
        }

        input, textarea {
            width: 100%;
            padding: 16px;
            border-radius: 14px;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 16px;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(91, 141, 239, 0.1);
        }

        /* Header Actions */
        .header-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s ease;
        }

        .icon-btn:active {
            transform: scale(0.95);
        }

        .back-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px 16px;
            color: var(--text-primary);
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 24px;
        }

        .action-buttons .btn {
            width: 100%;
            justify-content: center;
        }

        .backup-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 12px;
        }

        .backup-buttons .btn {
            width: 100%;
        }

        input[type="file"] {
            display: none;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .save-indicator {
            font-size: 12px;
            color: var(--success);
            margin-top: 4px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .save-indicator.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // Data management
        let lotti = [];
        let currentView = 'home';
        let currentLottoId = null;
        let contextMenuLottoId = null;
        let longPressTimer = null;
        let saveIndicatorTimer = null;

        // Load data from localStorage
        function loadData() {
            try {
                const saved = localStorage.getItem('dashboardAcquisti');
                if (saved) {
                    lotti = JSON.parse(saved);
                    console.log('‚úì Dati caricati:', lotti.length, 'lotti');
                }
            } catch (error) {
                console.error('Errore caricamento dati:', error);
                alert('Errore nel caricamento dei dati. I dati potrebbero essere corrotti.');
            }
        }

        // Save data to localStorage with error handling
        function saveData() {
            try {
                const dataStr = JSON.stringify(lotti);
                localStorage.setItem('dashboardAcquisti', dataStr);
                
                // Verifica che i dati siano stati salvati correttamente
                const verification = localStorage.getItem('dashboardAcquisti');
                if (verification === dataStr) {
                    showSaveIndicator();
                    console.log('‚úì Dati salvati:', lotti.length, 'lotti');
                } else {
                    throw new Error('Verifica salvataggio fallita');
                }
            } catch (error) {
                console.error('Errore salvataggio dati:', error);
                alert('ATTENZIONE: Errore nel salvataggio dei dati! Esporta immediatamente un backup.');
            }
        }

        // Show save indicator
        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            if (indicator) {
                indicator.classList.add('show');
                
                if (saveIndicatorTimer) {
                    clearTimeout(saveIndicatorTimer);
                }
                
                saveIndicatorTimer = setTimeout(() => {
                    indicator.classList.remove('show');
                }, 2000);
            }
        }

        // Format currency - arrotondamento per eccesso, no decimali
        function formatCurrency(value) {
            if (!value && value !== 0) return '0 ‚Ç¨';
            const num = Math.ceil(parseFloat(value)); // Arrotondamento per eccesso
            
            // Format with dot separator for thousands
            const formatted = num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            
            return formatted + ' ‚Ç¨';
        }

        // Format percentage
        function formatPercentage(value) {
            const num = parseFloat(value) || 0;
            return num.toFixed(2).replace('.', ',') + '%';
        }

        // Calculate totals for a lotto
        function calculateLottoTotals(lotto) {
            let totalCosto = 0;
            let totalRicavo = 0;
            
            if (lotto.records) {
                lotto.records.forEach(record => {
                    totalCosto += parseFloat(record.costo) || 0;
                    totalRicavo += parseFloat(record.ricavo) || 0;
                });
            }
            
            const margine = totalRicavo - totalCosto;
            const marginePerc = totalCosto > 0 ? (margine / totalCosto * 100) : 0;
            
            return { totalCosto, totalRicavo, margine, marginePerc };
        }

        // Calculate global totals
        function calculateGlobalTotals() {
            let totalCosto = 0;
            let totalRicavo = 0;
            
            lotti.forEach(lotto => {
                const totals = calculateLottoTotals(lotto);
                totalCosto += totals.totalCosto;
                totalRicavo += totals.totalRicavo;
            });
            
            const margine = totalRicavo - totalCosto;
            const marginePerc = totalCosto > 0 ? (margine / totalCosto * 100) : 0;
            
            return { totalCosto, totalRicavo, margine, marginePerc };
        }

        // Render home view
        function renderHome() {
            const totals = calculateGlobalTotals();
            const totalArticoli = lotti.reduce((sum, l) => sum + (l.records?.length || 0), 0);
            
            const html = `
                <div class="container">
                    <header>
                        <div>
                            <h1>Dashboard Acquisti</h1>
                            <p class="subtitle">Gestione Spese e Ricavi</p>
                            <div id="saveIndicator" class="save-indicator">‚úì Salvato</div>
                        </div>
                        <div class="header-actions">
                            <div class="icon-btn" onclick="showBackupModal()">‚öôÔ∏è</div>
                        </div>
                    </header>
                    
                    <div class="stats-grid">
                        <div class="stat-card dark">
                            <div class="stat-label">Totale Lotti</div>
                            <div class="stat-value">${lotti.length}</div>
                            <div class="stat-subtitle">${totalArticoli} articoli</div>
                        </div>
                        
                        <div class="stat-card red">
                            <div class="stat-label">Spese Totali</div>
                            <div class="stat-value">${formatCurrency(totals.totalCosto)}</div>
                            <div class="stat-subtitle">Investimento</div>
                        </div>
                        
                        <div class="stat-card green">
                            <div class="stat-label">Ricavi Totali</div>
                            <div class="stat-value">${formatCurrency(totals.totalRicavo)}</div>
                            <div class="stat-subtitle">Incassato</div>
                        </div>
                        
                        <div class="stat-card blue">
                            <div class="stat-label">Saldo Netto</div>
                            <div class="stat-value">${formatCurrency(totals.margine)}</div>
                            <div class="stat-subtitle">‚úì Profitto</div>
                        </div>
                        
                        <div class="stat-card dark">
                            <div class="stat-label">Margine %</div>
                            <div class="stat-value" style="color: ${totals.marginePerc >= 0 ? 'var(--success)' : 'var(--danger)'}">${formatPercentage(totals.marginePerc)}</div>
                        </div>
                        
                        <div class="stat-card dark">
                            <div class="stat-label">ROI</div>
                            <div class="stat-value" style="color: ${totals.marginePerc >= 0 ? 'var(--success)' : 'var(--danger)'}">${formatPercentage(totals.marginePerc)}</div>
                        </div>
                    </div>

                    <div class="section-header">
                        <h2>I Tuoi Lotti</h2>
                        <button class="btn btn-primary btn-small" onclick="showCreateLottoModal()">+ Nuovo</button>
                    </div>

                    <div id="lottiList">
                        ${lotti.length === 0 ? `
                            <div class="empty-state">
                                <div class="empty-state-icon">üì¶</div>
                                <p>Nessun lotto presente</p>
                                <p style="font-size: 14px; margin-top: 8px;">Crea il tuo primo lotto per iniziare</p>
                            </div>
                        ` : lotti.map(lotto => {
                            const totals = calculateLottoTotals(lotto);
                            return `
                                <div class="lotto-card" 
                                     onclick="openLotto('${lotto.id}')"
                                     ontouchstart="startLongPress('${lotto.id}', event)"
                                     ontouchend="cancelLongPress()"
                                     ontouchmove="cancelLongPress()">
                                    <div class="lotto-header">
                                        <div class="lotto-name">${lotto.nome}</div>
                                    </div>
                                    <div class="lotto-stats">
                                        <div class="lotto-stat-item">
                                            <div class="lotto-stat-label">Costi</div>
                                            <div class="lotto-stat-value">${formatCurrency(totals.totalCosto)}</div>
                                        </div>
                                        <div class="lotto-stat-item">
                                            <div class="lotto-stat-label">Ricavi</div>
                                            <div class="lotto-stat-value" style="color: var(--success)">${formatCurrency(totals.totalRicavo)}</div>
                                        </div>
                                        <div class="lotto-stat-item">
                                            <div class="lotto-stat-label">Margine</div>
                                            <div class="lotto-stat-value" style="color: ${totals.marginePerc >= 0 ? 'var(--success)' : 'var(--danger)'}">
                                                ${formatPercentage(totals.marginePerc)}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            
            document.getElementById('app').innerHTML = html;
        }

        // Render lotto detail view
        function renderLottoDetail(lottoId) {
            const lotto = lotti.find(l => l.id === lottoId);
            if (!lotto) {
                renderHome();
                return;
            }
            
            const totals = calculateLottoTotals(lotto);
            
            const html = `
                <div class="container">
                    <button class="back-btn" onclick="goHome()">‚Üê Indietro</button>
                    
                    <header>
                        <div>
                            <h1>${lotto.nome}</h1>
                            <div id="saveIndicator" class="save-indicator">‚úì Salvato</div>
                        </div>
                    </header>
                    
                    <div class="summary-card">
                        <h2 style="margin-bottom: 8px; font-size: 18px;">Riepilogo Lotto</h2>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <div class="summary-label">Costi Totali</div>
                                <div class="summary-value">${formatCurrency(totals.totalCosto)}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Ricavi Totali</div>
                                <div class="summary-value" style="color: var(--success)">${formatCurrency(totals.totalRicavo)}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Margine</div>
                                <div class="summary-value" style="color: ${totals.margine >= 0 ? 'var(--success)' : 'var(--danger)'}">${formatCurrency(totals.margine)}</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Margine %</div>
                                <div class="summary-value" style="color: ${totals.marginePerc >= 0 ? 'var(--success)' : 'var(--danger)'}">
                                    ${formatPercentage(totals.marginePerc)}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="section-header">
                        <h2>Records</h2>
                        <button class="btn btn-primary btn-small" onclick="showAddRecordModal()">+ Nuovo</button>
                    </div>

                    <div id="recordsList">
                        ${!lotto.records || lotto.records.length === 0 ? `
                            <div class="empty-state">
                                <div class="empty-state-icon">üìù</div>
                                <p>Nessun record presente</p>
                                <p style="font-size: 14px; margin-top: 8px;">Aggiungi il primo record</p>
                            </div>
                        ` : lotto.records.map((record, index) => {
                            const margine = (parseFloat(record.ricavo) || 0) - (parseFloat(record.costo) || 0);
                            return `
                                <div class="record-item">
                                    <div class="record-header">
                                        <div class="record-text">${record.testo}</div>
                                        <div class="record-actions">
                                            <button class="edit-record-btn" onclick="editRecord(${index})">‚úèÔ∏è</button>
                                            <button class="delete-record-btn" onclick="deleteRecord(${index})">üóëÔ∏è</button>
                                        </div>
                                    </div>
                                    <div class="record-values">
                                        <div class="record-value-item">
                                            <div class="record-value-label">COSTO</div>
                                            <div>${formatCurrency(record.costo)}</div>
                                        </div>
                                        <div class="record-value-item">
                                            <div class="record-value-label">RICAVO</div>
                                            <div style="color: var(--success)">${formatCurrency(record.ricavo)}</div>
                                        </div>
                                        <div class="record-value-item">
                                            <div class="record-value-label">MARGINE</div>
                                            <div style="color: ${margine >= 0 ? 'var(--success)' : 'var(--danger)'}">${formatCurrency(margine)}</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            
            document.getElementById('app').innerHTML = html;
        }

        // Long press handling
        function startLongPress(lottoId, event) {
            event.stopPropagation();
            contextMenuLottoId = lottoId;
            longPressTimer = setTimeout(() => {
                showLottoActionModal();
            }, 500);
        }

        function cancelLongPress() {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        }

        function showLottoActionModal() {
            const lotto = lotti.find(l => l.id === contextMenuLottoId);
            if (!lotto) return;
            
            showModal(`
                <div class="modal-header">
                    <h2 class="modal-title">${lotto.nome}</h2>
                    <button class="close-btn" onclick="closeModal()">√ó</button>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="editLottoFromMenu()">Modifica</button>
                    <button class="btn btn-danger" onclick="deleteLottoFromMenu()">Cancella</button>
                    <button class="btn btn-secondary" onclick="closeModal()">Annulla</button>
                </div>
            `);
        }

        function editLottoFromMenu() {
            closeModal();
            setTimeout(() => editLotto(), 100);
        }

        function deleteLottoFromMenu() {
            closeModal();
            setTimeout(() => deleteLotto(), 100);
        }

        function editLotto() {
            const lotto = lotti.find(l => l.id === contextMenuLottoId);
            if (lotto) {
                showModal(`
                    <div class="modal-header">
                        <h2 class="modal-title">Modifica Lotto</h2>
                        <button class="close-btn" onclick="closeModal()">√ó</button>
                    </div>
                    <div class="form-group">
                        <label>Nome Lotto</label>
                        <input type="text" id="editLottoName" value="${lotto.nome}" placeholder="Es: Lotto LEGO Set 2024">
                    </div>
                    <button class="btn btn-primary" style="width: 100%;" onclick="saveEditLotto()">Salva Modifiche</button>
                `);
            }
        }

        function saveEditLotto() {
            const nome = document.getElementById('editLottoName').value.trim();
            if (!nome) {
                alert('Inserisci un nome per il lotto');
                return;
            }
            
            const lotto = lotti.find(l => l.id === contextMenuLottoId);
            if (lotto) {
                lotto.nome = nome;
                saveData();
                closeModal();
                renderHome();
            }
        }

        function deleteLotto() {
            if (confirm('Sei sicuro di voler eliminare questo lotto? Tutti i records verranno eliminati.')) {
                lotti = lotti.filter(l => l.id !== contextMenuLottoId);
                saveData();
                renderHome();
            }
        }

        // Modal functions
        function showModal(content) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'activeModal';
            modal.innerHTML = `<div class="modal-content">${content}</div>`;
            document.body.appendChild(modal);
        }

        function closeModal() {
            const modal = document.getElementById('activeModal');
            if (modal) {
                modal.remove();
            }
        }

        function showCreateLottoModal() {
            showModal(`
                <div class="modal-header">
                    <h2 class="modal-title">Nuovo Lotto</h2>
                    <button class="close-btn" onclick="closeModal()">√ó</button>
                </div>
                <div class="form-group">
                    <label>Nome Lotto</label>
                    <input type="text" id="newLottoName" placeholder="Es: Lotto LEGO Set 2024" autofocus>
                </div>
                <button class="btn btn-primary" style="width: 100%;" onclick="createLotto()">Crea Lotto</button>
            `);
        }

        function createLotto() {
            const nome = document.getElementById('newLottoName').value.trim();
            if (!nome) {
                alert('Inserisci un nome per il lotto');
                return;
            }
            
            const newLotto = {
                id: Date.now().toString(),
                nome: nome,
                records: []
            };
            
            lotti.push(newLotto);
            saveData();
            closeModal();
            renderHome();
        }

        function showAddRecordModal() {
            showModal(`
                <div class="modal-header">
                    <h2 class="modal-title">Nuovo Record</h2>
                    <button class="close-btn" onclick="closeModal()">√ó</button>
                </div>
                <div class="form-group">
                    <label>Descrizione</label>
                    <input type="text" id="recordTesto" placeholder="Es: LEGO Star Wars Set 75192">
                </div>
                <div class="form-group">
                    <label>Costo (‚Ç¨)</label>
                    <input type="number" id="recordCosto" placeholder="0" step="1">
                </div>
                <div class="form-group">
                    <label>Ricavo (‚Ç¨)</label>
                    <input type="number" id="recordRicavo" placeholder="0" step="1">
                </div>
                <button class="btn btn-primary" style="width: 100%;" onclick="addRecord()">Aggiungi Record</button>
            `);
        }

        function addRecord() {
            const testo = document.getElementById('recordTesto').value.trim();
            const costo = document.getElementById('recordCosto').value;
            const ricavo = document.getElementById('recordRicavo').value;
            
            if (!testo) {
                alert('Inserisci una descrizione');
                return;
            }
            
            const lotto = lotti.find(l => l.id === currentLottoId);
            if (lotto) {
                if (!lotto.records) {
                    lotto.records = [];
                }
                lotto.records.push({
                    testo: testo,
                    costo: parseFloat(costo) || 0,
                    ricavo: parseFloat(ricavo) || 0
                });
                saveData();
                closeModal();
                renderLottoDetail(currentLottoId);
            }
        }

        function deleteRecord(index) {
            if (confirm('Sei sicuro di voler eliminare questo record?')) {
                const lotto = lotti.find(l => l.id === currentLottoId);
                if (lotto && lotto.records) {
                    lotto.records.splice(index, 1);
                    saveData();
                    renderLottoDetail(currentLottoId);
                }
            }
        }

        function editRecord(index) {
            const lotto = lotti.find(l => l.id === currentLottoId);
            if (!lotto || !lotto.records || !lotto.records[index]) return;
            
            const record = lotto.records[index];
            
            showModal(`
                <div class="modal-header">
                    <h2 class="modal-title">Modifica Record</h2>
                    <button class="close-btn" onclick="closeModal()">√ó</button>
                </div>
                <div class="form-group">
                    <label>Descrizione</label>
                    <input type="text" id="editRecordTesto" value="${record.testo}" placeholder="Es: LEGO Star Wars Set 75192">
                </div>
                <div class="form-group">
                    <label>Costo (‚Ç¨)</label>
                    <input type="number" id="editRecordCosto" value="${record.costo}" placeholder="0" step="1">
                </div>
                <div class="form-group">
                    <label>Ricavo (‚Ç¨)</label>
                    <input type="number" id="editRecordRicavo" value="${record.ricavo}" placeholder="0" step="1">
                </div>
                <button class="btn btn-primary" style="width: 100%;" onclick="saveEditRecord(${index})">Salva Modifiche</button>
            `);
        }

        function saveEditRecord(index) {
            const testo = document.getElementById('editRecordTesto').value.trim();
            const costo = document.getElementById('editRecordCosto').value;
            const ricavo = document.getElementById('editRecordRicavo').value;
            
            if (!testo) {
                alert('Inserisci una descrizione');
                return;
            }
            
            const lotto = lotti.find(l => l.id === currentLottoId);
            if (lotto && lotto.records && lotto.records[index]) {
                lotto.records[index] = {
                    testo: testo,
                    costo: parseFloat(costo) || 0,
                    ricavo: parseFloat(ricavo) || 0
                };
                saveData();
                closeModal();
                renderLottoDetail(currentLottoId);
            }
        }

        function showBackupModal() {
            const dataSize = new Blob([JSON.stringify(lotti)]).size;
            const dataSizeKB = (dataSize / 1024).toFixed(2);
            
            showModal(`
                <div class="modal-header">
                    <h2 class="modal-title">Impostazioni</h2>
                    <button class="close-btn" onclick="closeModal()">√ó</button>
                </div>
                <p style="color: var(--text-secondary); margin-bottom: 12px; font-size: 14px;">
                    <strong>Dati salvati:</strong> ${lotti.length} lotti (${dataSizeKB} KB)
                </p>
                <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 13px;">
                    üí° Esporta regolarmente un backup per sicurezza
                </p>
                <div class="backup-buttons">
                    <button class="btn btn-primary" onclick="exportData()">üíæ Esporta Backup</button>
                    <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">üì§ Importa Backup</button>
                    <button class="btn btn-danger" onclick="clearAllData()" style="margin-top: 20px;">üóëÔ∏è Elimina Tutti i Dati</button>
                </div>
                <input type="file" id="importFile" accept=".json" onchange="importData(event)">
            `);
        }

        function exportData() {
            try {
                const dataStr = JSON.stringify(lotti, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                link.download = `dashboard-acquisti-${timestamp}.json`;
                link.click();
                URL.revokeObjectURL(url);
                
                alert('‚úì Backup esportato con successo!');
            } catch (error) {
                console.error('Errore export:', error);
                alert('Errore durante l\'esportazione del backup');
            }
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    
                    // Validazione base
                    if (!Array.isArray(imported)) {
                        throw new Error('Formato file non valido');
                    }
                    
                    if (confirm(`Importare ${imported.length} lotti? I dati attuali verranno sostituiti.`)) {
                        lotti = imported;
                        saveData();
                        closeModal();
                        renderHome();
                        alert('‚úì Dati importati con successo!');
                    }
                } catch (error) {
                    console.error('Errore import:', error);
                    alert('Errore: Il file di backup non √® valido o √® corrotto.');
                }
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            if (confirm('‚ö†Ô∏è ATTENZIONE: Eliminare TUTTI i dati?\n\nQuesta azione √® IRREVERSIBILE!\n\nAssicurati di aver esportato un backup prima di procedere.')) {
                if (confirm('Sei SICURO? Tutti i lotti e i records verranno eliminati definitivamente.')) {
                    try {
                        lotti = [];
                        localStorage.removeItem('dashboardAcquisti');
                        closeModal();
                        renderHome();
                        alert('‚úì Tutti i dati sono stati eliminati');
                    } catch (error) {
                        console.error('Errore eliminazione:', error);
                        alert('Errore durante l\'eliminazione dei dati');
                    }
                }
            }
        }

        function openLotto(lottoId) {
            currentLottoId = lottoId;
            renderLottoDetail(lottoId);
        }

        function goHome() {
            currentLottoId = null;
            renderHome();
        }

        // Initialize app
        window.addEventListener('load', () => {
            loadData();
            renderHome();
        });

        // Auto-save on page unload (extra safety)
        window.addEventListener('beforeunload', () => {
            saveData();
        });
    </script>
</body>
</html>
